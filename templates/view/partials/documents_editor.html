<!-- CSS -->
<link rel="stylesheet" href="/static/css/documents_editor.css">
<!-- Quill CSS -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<!-- Área de mensagens -->
<div id="documents-message-area"></div>

<div class="container-fluid">
    <div class="row">
        <!-- Coluna da esquerda para formulários -->
        <div class="col-md-4">
            <div class="card bg-dark mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Configuração do Documento</h5>
                </div>
                <div class="card-body">
                    <!-- Seleção do tipo de documento -->
                    <div class="mb-4">
                        <label class="form-label">Tipo de Documento</label>
                        <select class="form-control" id="document-type" name="value"
                                hx-get="/patients/{{.Patient.ID}}/documents/template"
                                hx-target="#document-preview"
                                hx-include="[name='value'], [name='abordagem'], [name='valor_sessao'], 
                                          [name='dia_semana'], [name='horario_sessao'], 
                                          [name='data_limite_pagamento'], [name='metodos_pagamento'],
                                          [name='data_fim_tratamento'], [name='data_inicio_ferias'],
                                          [name='data_fim_ferias']"
                                hx-trigger="change">
                            <option value="">Selecione o tipo de documento...</option>
                            <optgroup label="Contratos">
                                <option value="contracts/presencial">Contrato Presencial</option>
                                <option value="contracts/online">Contrato Online</option>
                            </optgroup>
                            <optgroup label="Documentos Psicológicos">
                                <option value="psychological/declaracao">Declaração</option>
                                <option value="psychological/atestado">Atestado</option>
                                <option value="psychological/relatorio">Relatório</option>
                                <option value="psychological/parecer">Parecer</option>
                            </optgroup>
                        </select>
                    </div>

                    <!-- Formulário de dados do contrato -->
                    <div id="contract-data" class="mb-4" style="display: none;">
                        <h6 class="mb-3">Dados do Contrato</h6>
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label">Abordagem</label>
                                <input type="text" class="form-control" name="abordagem" 
                                       placeholder="Ex: Terapia Cognitivo-Comportamental"
                                       hx-get="/patients/{{.Patient.ID}}/documents/template"
                                       hx-target="#document-preview"
                                       hx-include="[name='value'], [name='abordagem'], [name='valor_sessao'], 
                                                 [name='dia_semana'], [name='horario_sessao'], 
                                                 [name='data_limite_pagamento'], [name='metodos_pagamento'],
                                                 [name='data_fim_tratamento'], [name='data_inicio_ferias'],
                                                 [name='data_fim_ferias']"
                                       hx-trigger="input">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Valor da Sessão</label>
                                <input type="text" class="form-control" name="valor_sessao" 
                                       placeholder="Ex: 150,00"
                                       hx-get="/patients/{{.Patient.ID}}/documents/template"
                                       hx-target="#document-preview"
                                       hx-include="[name='value'], [name='abordagem'], [name='valor_sessao'], 
                                                 [name='dia_semana'], [name='horario_sessao'], 
                                                 [name='data_limite_pagamento'], [name='metodos_pagamento'],
                                                 [name='data_fim_tratamento'], [name='data_inicio_ferias'],
                                                 [name='data_fim_ferias']"
                                       hx-trigger="input">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Dia da Semana</label>
                                <select class="form-control" name="dia_semana"
                                        hx-get="/patients/{{.Patient.ID}}/documents/template"
                                        hx-target="#document-preview"
                                        hx-include="[name='value'], [name='abordagem'], [name='valor_sessao'], 
                                                  [name='dia_semana'], [name='horario_sessao'], 
                                                  [name='data_limite_pagamento'], [name='metodos_pagamento'],
                                                  [name='data_fim_tratamento'], [name='data_inicio_ferias'],
                                                  [name='data_fim_ferias']"
                                        hx-trigger="change">
                                    <option value="">Selecione...</option>
                                    <option value="segundas-feiras">Segunda-feira</option>
                                    <option value="terças-feiras">Terça-feira</option>
                                    <option value="quartas-feiras">Quarta-feira</option>
                                    <option value="quintas-feiras">Quinta-feira</option>
                                    <option value="sextas-feiras">Sexta-feira</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Horário da Sessão</label>
                                <input type="time" class="form-control" name="horario_sessao"
                                       hx-get="/patients/{{.Patient.ID}}/documents/template"
                                       hx-target="#document-preview"
                                       hx-include="[name='value'], [name='abordagem'], [name='valor_sessao'], 
                                                 [name='dia_semana'], [name='horario_sessao'], 
                                                 [name='data_limite_pagamento'], [name='metodos_pagamento'],
                                                 [name='data_fim_tratamento'], [name='data_inicio_ferias'],
                                                 [name='data_fim_ferias']"
                                       hx-trigger="input">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Data Limite Pagamento</label>
                                <input type="text" class="form-control" name="data_limite_pagamento" 
                                       placeholder="Ex: dia 10"
                                       hx-get="/patients/{{.Patient.ID}}/documents/template"
                                       hx-target="#document-preview"
                                       hx-include="[name='value'], [name='abordagem'], [name='valor_sessao'], 
                                                 [name='dia_semana'], [name='horario_sessao'], 
                                                 [name='data_limite_pagamento'], [name='metodos_pagamento'],
                                                 [name='data_fim_tratamento'], [name='data_inicio_ferias'],
                                                 [name='data_fim_ferias']"
                                       hx-trigger="input">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Métodos de Pagamento</label>
                                <input type="text" class="form-control" name="metodos_pagamento" 
                                       placeholder="Ex: PIX, transferência bancária"
                                       hx-get="/patients/{{.Patient.ID}}/documents/template"
                                       hx-target="#document-preview"
                                       hx-include="[name='value'], [name='abordagem'], [name='valor_sessao'], 
                                                 [name='dia_semana'], [name='horario_sessao'], 
                                                 [name='data_limite_pagamento'], [name='metodos_pagamento'],
                                                 [name='data_fim_tratamento'], [name='data_inicio_ferias'],
                                                 [name='data_fim_ferias']"
                                       hx-trigger="input">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Data de Término</label>
                                <input type="date" class="form-control" name="data_fim_tratamento"
                                       hx-get="/patients/{{.Patient.ID}}/documents/template"
                                       hx-target="#document-preview"
                                       hx-include="[name='value'], [name='abordagem'], [name='valor_sessao'], 
                                                 [name='dia_semana'], [name='horario_sessao'], 
                                                 [name='data_limite_pagamento'], [name='metodos_pagamento'],
                                                 [name='data_fim_tratamento'], [name='data_inicio_ferias'],
                                                 [name='data_fim_ferias']"
                                       hx-trigger="input">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Início das Férias</label>
                                <input type="date" class="form-control" name="data_inicio_ferias"
                                       hx-get="/patients/{{.Patient.ID}}/documents/template"
                                       hx-target="#document-preview"
                                       hx-include="[name='value'], [name='abordagem'], [name='valor_sessao'], 
                                                 [name='dia_semana'], [name='horario_sessao'], 
                                                 [name='data_limite_pagamento'], [name='metodos_pagamento'],
                                                 [name='data_fim_tratamento'], [name='data_inicio_ferias'],
                                                 [name='data_fim_ferias']"
                                       hx-trigger="input">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Fim das Férias</label>
                                <input type="date" class="form-control" name="data_fim_ferias"
                                       hx-get="/patients/{{.Patient.ID}}/documents/template"
                                       hx-target="#document-preview"
                                       hx-include="[name='value'], [name='abordagem'], [name='valor_sessao'], 
                                                 [name='dia_semana'], [name='horario_sessao'], 
                                                 [name='data_limite_pagamento'], [name='metodos_pagamento'],
                                                 [name='data_fim_tratamento'], [name='data_inicio_ferias'],
                                                 [name='data_fim_ferias']"
                                       hx-trigger="input">
                            </div>
                        </div>
                    </div>

                    <!-- Botões de ação -->
                    <div class="d-flex justify-content-end mt-4">
                        <button type="button" class="btn btn-secondary me-2" 
                                hx-get="/patients/{{.Patient.ID}}"
                                hx-target="#content-area">
                            Cancelar
                        </button>
                        <button type="button" class="btn btn-primary"
                                hx-post="/documents/save"
                                hx-include="[name='value'], [name='document-name'], #document-preview"
                                hx-target="#documents-message-area">
                            Salvar Documento
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Coluna da direita para preview -->
        <div class="col-md-8">
            <div class="card bg-dark">
                <div class="card-header">
                    <h5 class="mb-0">Pré-visualização do Documento</h5>
                </div>
                <div class="card-body">
                    <div id="document-preview" class="bg-white p-4 rounded"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quill JS -->
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const typeSelect = document.getElementById('document-type');
    const nameInput = document.getElementById('document-name');
    const saveButton = document.getElementById('save-document');
    
    // Habilita/desabilita campos baseado na seleção do tipo
    typeSelect.addEventListener('change', function() {
        const isSelected = !!this.value;
        nameInput.disabled = !isSelected;
        saveButton.disabled = !isSelected;
        
        if (isSelected) {
            // Gera um nome padrão baseado no tipo selecionado
            const option = this.options[this.selectedIndex];
            const tipo = option.text;
            const data = new Date().toLocaleDateString('pt-BR');
            nameInput.value = `${tipo} - ${data}`;
            nameInput.select(); // Seleciona o texto para fácil edição
        } else {
            nameInput.value = '';
        }
    });

    // Inicializa Quill quando o template for carregado
    document.body.addEventListener('htmx:afterSettle', function() {
        const editors = document.querySelectorAll('.quill-editor');
        editors.forEach(function(editor) {
            new Quill(editor, {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['clean']
                    ]
                }
            });
        });
    });

    // Coleta dados do Quill antes de salvar
    document.body.addEventListener('htmx:beforeRequest', function(evt) {
        if (evt.detail.elt.id === 'save-document') {
            const editors = document.querySelectorAll('.quill-editor');
            const editorContents = {};
            
            editors.forEach(function(editor) {
                const quill = Quill.find(editor);
                const fieldName = editor.dataset.field;
                editorContents[fieldName] = quill.root.innerHTML;
            });

            // Adiciona os conteúdos dos editores ao request
            evt.detail.parameters['editor_contents'] = JSON.stringify(editorContents);
        }
    });
});

// Mostrar/ocultar formulário de dados do contrato baseado no tipo selecionado
document.getElementById('document-type').addEventListener('change', function() {
    const contractData = document.getElementById('contract-data');
    if (this.value.startsWith('contracts/')) {
        contractData.style.display = 'block';
    } else {
        contractData.style.display = 'none';
    }
});

// Formatar valor da sessão
document.querySelector('[name="valor_sessao"]').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    value = (parseInt(value) / 100).toFixed(2);
    e.target.value = value;
});
</script>
