<!-- Include stylesheet -->
<link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet" />

<!-- Create the editor container -->
<div id="editor">
    <h1>Relatório Psicológico</h1>
    <p><strong>Data:</strong> </p>
    <p><strong>Paciente:</strong> </p>
    <p><br></p>
    <h2>1. Identificação</h2>
    <p>[Informações de identificação do paciente]</p>
    <p><br></p>
    <h2>2. Demanda</h2>
    <p>[Motivo do atendimento/avaliação]</p>
    <p><br></p>
    <h2>3. Análise</h2>
    <p>[Análise do caso]</p>
    <p><br></p>
    <h2>4. Conclusão</h2>
    <p>[Conclusões e recomendações]</p>
</div>

<style>
    #editor {
        width: 100%;
        height: 100vh;
        margin: 0;
        background: white;
        display: flex;
        flex-direction: column;
    }

    /* Container do editor */
    .ql-container.ql-snow {
        flex: 1;
        border: none !important;
        font-size: 16px;
    }

    /* Barra de ferramentas */
    .ql-toolbar.ql-snow {
        background: #2f3742;
        border: none !important;
        padding: 8px;
        position: sticky;
        top: 0;
        z-index: 1000;
    }

    /* Cores dos ícones */
    .ql-snow .ql-stroke {
        stroke: #fff !important;
    }

    .ql-snow .ql-fill {
        fill: #fff !important;
    }

    .ql-snow .ql-picker {
        color: #fff !important;
    }

    .ql-snow .ql-picker-options {
        background-color: #2f3742 !important;
        border-color: #444 !important;
    }
</style>

<script>
    let editorInstance = null;  // Variável para controlar a instância do editor

    // Função para carregar script dinamicamente
    function loadScript(url) {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = url;
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
        });
    }

    // Função de inicialização do Quill
    function initQuill() {
        console.log('Iniciando Quill');
        // Se já existe uma instância, não cria outra
        if (editorInstance) {
            console.log('Editor já está inicializado');
            return;
        }

        if (typeof Quill === 'undefined') {
            console.log('Quill não está definido, carregando script...');
            loadScript('https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js')
                .then(() => {
                    console.log('Script do Quill carregado');
                    createEditor();
                })
                .catch(error => {
                    console.error('Erro ao carregar script do Quill:', error);
                });
        } else {
            console.log('Quill já está definido');
            createEditor();
        }
    }

    // Função para criar o editor
    function createEditor() {
        try {
            // Verifica se já existe uma instância
            if (editorInstance) {
                console.log('Editor já existe');
                return;
            }

            // Remove qualquer toolbar existente antes de criar uma nova
            const existingToolbars = document.querySelectorAll('.ql-toolbar');
            existingToolbars.forEach(toolbar => toolbar.remove());

            editorInstance = new Quill('#editor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, false] }],
                        ['bold', 'italic', 'underline'],
                        [{ 'align': [] }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'indent': '-1'}, { 'indent': '+1' }],
                        ['clean']
                    ]
                }
            });
            console.log('Quill inicializado com sucesso');
        } catch (error) {
            console.error('Erro ao inicializar Quill:', error);
        }
    }

    // Limpa a instância existente quando o conteúdo é removido
    document.addEventListener('htmx:beforeSwap', function(event) {
        if (editorInstance) {
            console.log('Limpando instância anterior do editor');
            editorInstance = null;
        }
    });

    // Inicializa quando o DOM estiver pronto
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initQuill);
    } else {
        initQuill();
    }

    // Também inicializa após o HTMX carregar o conteúdo
    document.addEventListener('htmx:afterSwap', function(event) {
        console.log('htmx:afterSwap triggered');
        initQuill();
    });
</script> 